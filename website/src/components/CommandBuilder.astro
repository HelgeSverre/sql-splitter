---
// Interactive Command Builder - Schema-driven with reactive updates
const categories = {
  transform: { color: '#0ea5e9', label: 'Transform' },
  inspect: { color: '#8b5cf6', label: 'Inspect' },
  verify: { color: '#f59e0b', label: 'Verify' },
  subset: { color: '#10b981', label: 'Subset' },
  privacy: { color: '#ef4444', label: 'Privacy' }
};

const commands = [
  { id: 'split', label: 'split', desc: 'Split dump into per-table files', category: 'transform', alias: 'sp' },
  { id: 'merge', label: 'merge', desc: 'Combine files into one dump', category: 'transform', alias: 'mg' },
  { id: 'convert', label: 'convert', desc: 'Transform between dialects', category: 'transform', alias: 'cv' },
  { id: 'analyze', label: 'analyze', desc: 'View table statistics', category: 'inspect', alias: 'an' },
  { id: 'query', label: 'query', desc: 'SQL analytics with DuckDB', category: 'inspect', alias: 'qy' },
  { id: 'graph', label: 'graph', desc: 'Generate ERD diagrams', category: 'inspect', alias: 'gr' },
  { id: 'order', label: 'order', desc: 'Topological FK ordering', category: 'inspect', alias: 'or' },
  { id: 'validate', label: 'validate', desc: 'Check integrity', category: 'verify', alias: 'vl' },
  { id: 'diff', label: 'diff', desc: 'Compare two dumps', category: 'verify', alias: 'df' },
  { id: 'sample', label: 'sample', desc: 'Create reduced datasets', category: 'subset', alias: 'sm' },
  { id: 'shard', label: 'shard', desc: 'Extract tenant data', category: 'subset', alias: 'sh' },
  { id: 'redact', label: 'redact', desc: 'Anonymize PII', category: 'privacy', alias: 'rd' }
];

const groupedCommands = {
  transform: commands.filter(c => c.category === 'transform'),
  inspect: commands.filter(c => c.category === 'inspect'),
  verify: commands.filter(c => c.category === 'verify'),
  subset: commands.filter(c => c.category === 'subset'),
  privacy: commands.filter(c => c.category === 'privacy'),
};
---

<div class="cb-root" id="command-builder">
  <!-- Command Output - Always visible at top -->
  <div class="cb-output-panel">
    <div class="cb-output-header">
      <span class="cb-output-label">Generated Command</span>
      <button class="cb-copy-btn" id="copy-command" type="button">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <rect x="9" y="9" width="13" height="13" rx="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <span>Copy</span>
      </button>
    </div>
    <div class="cb-output-code">
      <pre id="generated-command"><code>sql-splitter split dump.sql -o output/</code></pre>
    </div>
  </div>

  <div class="cb-main">
    <!-- Left: Command Picker -->
    <div class="cb-commands">
      <div class="cb-section-title">Select Command</div>
      {Object.entries(groupedCommands).map(([cat, cmds]) => (
        <div class="cb-cmd-group" data-category={cat}>
          <div class="cb-cmd-group-label" style={`--cat-color: ${categories[cat].color}`}>
            {categories[cat].label}
          </div>
          <div class="cb-cmd-list">
            {cmds.map(cmd => (
              <button
                type="button"
                class={`cb-cmd-btn ${cmd.id === 'split' ? 'active' : ''}`}
                data-command={cmd.id}
                style={`--cat-color: ${categories[cat].color}`}
              >
                <span class="cb-cmd-name">{cmd.label}</span>
                <span class="cb-cmd-desc">{cmd.desc}</span>
              </button>
            ))}
          </div>
        </div>
      ))}
    </div>

    <!-- Right: Options Panel -->
    <div class="cb-options">
      <!-- Input/Output -->
      <div class="cb-option-group">
        <div class="cb-option-title">Files</div>
        
        <div class="cb-field">
          <label for="input-file">Input</label>
          <input type="text" id="input-file" value="dump.sql" placeholder="dump.sql" />
        </div>

        <div class="cb-field" id="input-file2-group" style="display: none;">
          <label for="input-file2">Compare With</label>
          <input type="text" id="input-file2" value="new.sql" placeholder="new.sql" />
        </div>

        <div class="cb-field" id="output-group">
          <label for="output">Output</label>
          <input type="text" id="output" value="output/" placeholder="output/" />
        </div>
      </div>

      <!-- Dialect -->
      <div class="cb-option-group" id="dialect-section">
        <div class="cb-option-title">Dialect</div>
        
        <div class="cb-field" id="dialect-group">
          <label for="dialect">Source</label>
          <select id="dialect">
            <option value="">Auto-detect</option>
            <option value="mysql">MySQL</option>
            <option value="postgres">PostgreSQL</option>
            <option value="sqlite">SQLite</option>
            <option value="mssql">MSSQL</option>
          </select>
        </div>

        <div class="cb-field" id="to-dialect-group" style="display: none;">
          <label for="to-dialect">Convert To</label>
          <select id="to-dialect">
            <option value="postgres">PostgreSQL</option>
            <option value="mysql">MySQL</option>
            <option value="sqlite">SQLite</option>
            <option value="mssql">MSSQL</option>
          </select>
        </div>
      </div>

      <!-- Command-specific Options -->
      <div class="cb-option-group" id="cmd-options-section" style="display: none;">
        <div class="cb-option-title">Options</div>
        
        <!-- Sample -->
        <div class="cb-field" id="percent-group" style="display: none;">
          <label for="percent">Sample %</label>
          <input type="number" id="percent" min="1" max="100" value="10" />
        </div>

        <!-- Shard -->
        <div class="cb-field" id="tenant-column-group" style="display: none;">
          <label for="tenant-column">Tenant Column</label>
          <input type="text" id="tenant-column" value="tenant_id" placeholder="tenant_id" />
        </div>

        <div class="cb-field" id="tenant-value-group" style="display: none;">
          <label for="tenant-value">Tenant Value</label>
          <input type="text" id="tenant-value" placeholder="123" />
        </div>

        <!-- Query -->
        <div class="cb-field" id="query-group" style="display: none;">
          <label for="query-text">SQL Query</label>
          <input type="text" id="query-text" value="SELECT COUNT(*) FROM users" placeholder="SELECT ..." />
        </div>

        <!-- Format -->
        <div class="cb-field" id="format-group" style="display: none;">
          <label for="format">Format</label>
          <select id="format">
            <option value="">Default</option>
            <option value="json">JSON</option>
            <option value="mermaid">Mermaid</option>
            <option value="dot">DOT</option>
            <option value="csv">CSV</option>
          </select>
        </div>

        <!-- Redact -->
        <div class="cb-field" id="hash-group" style="display: none;">
          <label for="hash-patterns">Hash Columns</label>
          <input type="text" id="hash-patterns" placeholder="*.email, *.ssn" />
        </div>

        <div class="cb-field" id="fake-group" style="display: none;">
          <label for="fake-patterns">Fake Data</label>
          <input type="text" id="fake-patterns" placeholder="*.name, *.phone" />
        </div>
      </div>

      <!-- Flags -->
      <div class="cb-option-group">
        <div class="cb-option-title">Flags</div>
        <div class="cb-flags">
          <label class="cb-flag" id="progress-opt">
            <input type="checkbox" id="progress" />
            <span>--progress</span>
          </label>
          <label class="cb-flag" id="dry-run-opt">
            <input type="checkbox" id="dry-run" />
            <span>--dry-run</span>
          </label>
          <label class="cb-flag" id="json-opt">
            <input type="checkbox" id="json" />
            <span>--json</span>
          </label>
          <label class="cb-flag" id="strict-opt" style="display: none;">
            <input type="checkbox" id="strict" />
            <span>--strict</span>
          </label>
          <label class="cb-flag" id="fail-fast-opt" style="display: none;">
            <input type="checkbox" id="fail-fast" />
            <span>--fail-fast</span>
          </label>
          <label class="cb-flag" id="preserve-relations-opt" style="display: none;">
            <input type="checkbox" id="preserve-relations" />
            <span>--preserve-relations</span>
          </label>
          <label class="cb-flag" id="interactive-opt" style="display: none;">
            <input type="checkbox" id="interactive" />
            <span>--interactive</span>
          </label>
          <label class="cb-flag" id="reverse-opt" style="display: none;">
            <input type="checkbox" id="reverse" />
            <span>--reverse</span>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  function initCommandBuilder() {
    const root = document.getElementById('command-builder');
    if (!root || root.dataset.initialized === 'true') return;
    root.dataset.initialized = 'true';

    let currentCommand = 'split';

    const $ = (id) => document.getElementById(id);
    const show = (id, visible) => {
      const el = $(id);
      if (el) el.style.display = visible ? '' : 'none';
    };

    function updateCommand() {
      const cmd = currentCommand;
      const input = ($('input-file') as HTMLInputElement)?.value || 'dump.sql';
      const input2 = ($('input-file2') as HTMLInputElement)?.value || 'new.sql';
      const output = ($('output') as HTMLInputElement)?.value;
      const dialect = ($('dialect') as HTMLSelectElement)?.value;
      const toDialect = ($('to-dialect') as HTMLSelectElement)?.value;
      const percent = ($('percent') as HTMLInputElement)?.value;
      const tenantValue = ($('tenant-value') as HTMLInputElement)?.value;
      const tenantColumn = ($('tenant-column') as HTMLInputElement)?.value;
      const queryText = ($('query-text') as HTMLInputElement)?.value;
      const format = ($('format') as HTMLSelectElement)?.value;
      const hashPatterns = ($('hash-patterns') as HTMLInputElement)?.value;
      const fakePatterns = ($('fake-patterns') as HTMLInputElement)?.value;

      const progress = ($('progress') as HTMLInputElement)?.checked;
      const dryRun = ($('dry-run') as HTMLInputElement)?.checked;
      const json = ($('json') as HTMLInputElement)?.checked;
      const strict = ($('strict') as HTMLInputElement)?.checked;
      const failFast = ($('fail-fast') as HTMLInputElement)?.checked;
      const preserveRelations = ($('preserve-relations') as HTMLInputElement)?.checked;
      const interactive = ($('interactive') as HTMLInputElement)?.checked;
      const reverse = ($('reverse') as HTMLInputElement)?.checked;

      const parts: string[] = ['sql-splitter', cmd];

      // Input files
      if (cmd === 'diff') {
        parts.push(input, input2);
      } else if (cmd !== 'query' || !interactive) {
        parts.push(input);
      }

      // Query text
      if (cmd === 'query' && queryText && !interactive) {
        parts.push(`"${queryText}"`);
      }

      // Output
      if (output && !['analyze', 'validate', 'query', 'order'].includes(cmd)) {
        parts.push('-o', output);
      }

      // Dialect
      if (dialect && cmd !== 'convert') {
        parts.push('-d', dialect);
      }

      // Convert
      if (cmd === 'convert' && toDialect) {
        parts.push('--to', toDialect);
        if (output) parts.push('-o', output);
      }

      // Sample
      if (cmd === 'sample' && percent) {
        parts.push('--percent', percent);
      }

      // Shard
      if (cmd === 'shard') {
        if (tenantColumn) parts.push('--tenant-column', tenantColumn);
        if (tenantValue) parts.push('--tenant-value', tenantValue);
        if (output) parts.push('-o', output);
      }

      // Redact
      if (cmd === 'redact') {
        if (hashPatterns) {
          hashPatterns.split(',').map(p => p.trim()).filter(Boolean).forEach(p => {
            parts.push('--hash', `"${p}"`);
          });
        }
        if (fakePatterns) {
          fakePatterns.split(',').map(p => p.trim()).filter(Boolean).forEach(p => {
            parts.push('--fake', `"${p}"`);
          });
        }
        if (output) parts.push('-o', output);
      }

      // Format
      if (format) {
        if (cmd === 'query') parts.push('-f', format);
        else if (['graph', 'diff'].includes(cmd)) parts.push('--format', format);
      }

      // Flags
      if (progress && !['order'].includes(cmd)) parts.push('--progress');
      if (dryRun && !['analyze', 'validate', 'query', 'graph', 'order'].includes(cmd)) parts.push('--dry-run');
      if (json && cmd !== 'query') parts.push('--json');
      if (strict && ['validate', 'convert', 'redact'].includes(cmd)) parts.push('--strict');
      if (failFast && ['split', 'analyze', 'convert', 'validate'].includes(cmd)) parts.push('--fail-fast');
      if (preserveRelations && cmd === 'sample') parts.push('--preserve-relations');
      if (interactive && cmd === 'query') parts.push('--interactive');
      if (reverse && cmd === 'order') parts.push('--reverse');

      const codeEl = document.querySelector('#generated-command code');
      if (codeEl) {
        codeEl.innerHTML = highlight(parts.join(' '));
      }
    }

    function highlight(cmd: string) {
      let html = cmd.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      html = html.replace(/^(sql-splitter)/, '<span class="hl-bin">$1</span>');
      html = html.replace(/^(<span[^>]*>sql-splitter<\/span>)\s+(\w+)/, '$1 <span class="hl-cmd">$2</span>');
      html = html.replace(/(--?[\w-]+)/g, '<span class="hl-flag">$1</span>');
      html = html.replace(/"([^"]+)"/g, '<span class="hl-str">"$1"</span>');
      return html;
    }

    function updateVisibility() {
      const cmd = currentCommand;

      // Files
      show('input-file2-group', cmd === 'diff');
      show('output-group', !['analyze', 'validate', 'order', 'query'].includes(cmd));

      // Dialect
      show('dialect-group', cmd !== 'convert');
      show('to-dialect-group', cmd === 'convert');

      // Command options section
      const hasCmdOptions = ['sample', 'shard', 'query', 'graph', 'diff', 'redact'].includes(cmd);
      show('cmd-options-section', hasCmdOptions);

      // Specific options
      show('percent-group', cmd === 'sample');
      show('tenant-column-group', cmd === 'shard');
      show('tenant-value-group', cmd === 'shard');
      show('query-group', cmd === 'query');
      show('format-group', ['graph', 'diff', 'query'].includes(cmd));
      show('hash-group', cmd === 'redact');
      show('fake-group', cmd === 'redact');

      // Flags
      show('progress-opt', !['order'].includes(cmd));
      show('dry-run-opt', !['analyze', 'validate', 'query', 'graph', 'order'].includes(cmd));
      show('json-opt', cmd !== 'query');
      show('strict-opt', ['validate', 'convert', 'redact'].includes(cmd));
      show('fail-fast-opt', ['split', 'analyze', 'convert', 'validate'].includes(cmd));
      show('preserve-relations-opt', cmd === 'sample');
      show('interactive-opt', cmd === 'query');
      show('reverse-opt', cmd === 'order');

      updateCommand();
    }

    // Command buttons
    root.querySelectorAll('.cb-cmd-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        root.querySelectorAll('.cb-cmd-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentCommand = (btn as HTMLElement).dataset.command || 'split';
        updateVisibility();
      });
    });

    // All inputs - reactive updates
    root.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', updateCommand);
      el.addEventListener('change', updateCommand);
    });

    // Copy button
    const copyBtn = document.getElementById('copy-command');
    copyBtn?.addEventListener('click', async () => {
      const code = document.querySelector('#generated-command code');
      if (!code) return;
      const text = code.textContent || '';
      try {
        await navigator.clipboard.writeText(text);
        const span = copyBtn.querySelector('span');
        if (span) {
          span.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            span.textContent = 'Copy';
            copyBtn.classList.remove('copied');
          }, 1500);
        }
      } catch (e) {
        console.error('Copy failed:', e);
      }
    });

    updateVisibility();
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCommandBuilder);
  } else {
    initCommandBuilder();
  }
  document.addEventListener('astro:page-load', () => {
    const root = document.getElementById('command-builder');
    if (root) root.dataset.initialized = 'false';
    initCommandBuilder();
  });
</script>

<style>
  .cb-root {
    --cb-bg: var(--sl-color-bg);
    --cb-surface: var(--sl-color-gray-6);
    --cb-surface-2: var(--sl-color-gray-5);
    --cb-border: var(--sl-color-gray-5);
    --cb-text: var(--sl-color-text);
    --cb-text-muted: var(--sl-color-gray-2);
    --cb-accent: var(--sl-color-accent);
    --cb-radius: 8px;
    
    font-family: var(--sl-font);
    color: var(--cb-text);
  }

  /* Output Panel - Sticky at top */
  .cb-output-panel {
    background: var(--cb-surface);
    border: 1px solid var(--cb-border);
    border-radius: var(--cb-radius);
    padding: 1rem;
    margin-bottom: 1.5rem;
    position: sticky;
    top: 4rem;
    z-index: 10;
  }

  .cb-output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .cb-output-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--cb-text-muted);
  }

  .cb-copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.65rem;
    border: 1px solid var(--cb-border);
    border-radius: 6px;
    background: var(--cb-bg);
    color: var(--cb-text);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 120ms ease;
  }

  .cb-copy-btn:hover {
    border-color: var(--cb-accent);
    background: color-mix(in srgb, var(--cb-accent) 10%, var(--cb-bg));
  }

  .cb-copy-btn.copied {
    border-color: #10b981;
    color: #10b981;
  }

  .cb-output-code {
    background: var(--cb-bg);
    border: 1px solid var(--cb-border);
    border-radius: 6px;
    padding: 0.875rem 1rem;
    overflow-x: auto;
  }

  .cb-output-code pre {
    margin: 0;
    font-family: var(--sl-font-mono);
    font-size: 0.9rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .cb-output-code code {
    background: none;
    padding: 0;
  }

  /* Syntax highlighting */
  .cb-output-code .hl-bin { color: var(--cb-accent); font-weight: 600; }
  .cb-output-code .hl-cmd { color: #0ea5e9; font-weight: 600; }
  .cb-output-code .hl-flag { color: var(--cb-text-muted); }
  .cb-output-code .hl-str { color: #10b981; }

  /* Main Layout */
  .cb-main {
    display: grid;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .cb-main {
      grid-template-columns: 280px 1fr;
    }
  }

  /* Commands Panel */
  .cb-commands {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .cb-section-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--cb-text-muted);
    margin-bottom: 0.25rem;
  }

  .cb-cmd-group {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .cb-cmd-group-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--cat-color);
    padding-left: 0.25rem;
  }

  .cb-cmd-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .cb-cmd-btn {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.15rem;
    padding: 0.5rem 0.75rem;
    border: 1px solid transparent;
    border-radius: 6px;
    background: var(--cb-surface);
    color: var(--cb-text);
    text-align: left;
    cursor: pointer;
    transition: all 120ms ease;
  }

  .cb-cmd-btn:hover {
    border-color: var(--cat-color);
    background: color-mix(in srgb, var(--cat-color) 8%, var(--cb-surface));
  }

  .cb-cmd-btn.active {
    border-color: var(--cat-color);
    background: color-mix(in srgb, var(--cat-color) 15%, var(--cb-surface));
    box-shadow: inset 3px 0 0 var(--cat-color);
  }

  .cb-cmd-name {
    font-family: var(--sl-font-mono);
    font-size: 0.85rem;
    font-weight: 600;
  }

  .cb-cmd-desc {
    font-size: 0.7rem;
    color: var(--cb-text-muted);
  }

  /* Options Panel */
  .cb-options {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .cb-option-group {
    background: var(--cb-surface);
    border: 1px solid var(--cb-border);
    border-radius: var(--cb-radius);
    padding: 1rem;
  }

  .cb-option-title {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--cb-text-muted);
    margin-bottom: 0.75rem;
  }

  .cb-option-group > .cb-field + .cb-field {
    margin-top: 0.75rem;
  }

  .cb-field {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .cb-field label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--cb-text-muted);
  }

  .cb-field input,
  .cb-field select {
    height: 2.25rem;
    padding: 0 0.75rem;
    border: 1px solid var(--cb-border);
    border-radius: 6px;
    background: var(--cb-bg);
    color: var(--cb-text);
    font-family: inherit;
    font-size: 0.875rem;
    transition: border-color 120ms, box-shadow 120ms;
  }

  .cb-field input:focus,
  .cb-field select:focus {
    outline: none;
    border-color: var(--cb-accent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--cb-accent) 25%, transparent);
  }

  .cb-field select {
    appearance: none;
    padding-right: 2rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
  }

  /* Flags */
  .cb-flags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .cb-flag {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.6rem;
    border: 1px solid var(--cb-border);
    border-radius: 999px;
    background: var(--cb-bg);
    font-size: 0.75rem;
    font-family: var(--sl-font-mono);
    cursor: pointer;
    transition: all 120ms ease;
  }

  .cb-flag:hover {
    border-color: var(--cb-accent);
  }

  .cb-flag:has(input:checked) {
    border-color: var(--cb-accent);
    background: color-mix(in srgb, var(--cb-accent) 15%, var(--cb-bg));
  }

  .cb-flag input {
    width: 0.9rem;
    height: 0.9rem;
    accent-color: var(--cb-accent);
  }

  /* Mobile adjustments */
  @media (max-width: 767px) {
    .cb-cmd-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }

    .cb-cmd-desc {
      display: none;
    }
  }
</style>
